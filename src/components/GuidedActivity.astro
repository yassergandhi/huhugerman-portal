---
// src/components/GuidedActivity.astro
import { getBackLink } from '@lib/navigation';
const { lesson } = Astro.props;
const backLink = getBackLink(lesson);
---

<div class="container">
  <div class="navbar" style="padding:0; border:none; margin-bottom:1rem;">
    <a
      href={backLink.href}
      style="color:var(--accent-primary); font-weight:bold; display:flex; align-items:center; gap:5px;"
    >
      <span>â†</span> {backLink.label}
    </a>
  </div>

  <h1>{lesson.title}</h1>

<!-- âœ… Mensaje estÃ¡tico sobre naturaleza formativa (SIEMPRE visible) -->
<div class="card activity-notice">
<h3>â„¹ï¸ Actividad formativa</h3>
<p>
Tu entrega es lo que cuenta. El feedback te ayuda a mejorar y la entrega se traduce despuÃ©s en la calificaciÃ³n institucional.
</p>


</div>


  <div class="card">
    <h3>ğŸ“ Instrucciones de la Actividad</h3>
    <p>{lesson.instructions.intro}</p>
    <ul>
      {lesson.instructions.grammarReminder.map(item => (
        <li>{item}</li>
      ))}
    </ul>
  </div>

  {lesson.source?.type === 'youtube' && (
    <div class="card" style="padding:0;">
      <div style="position:relative; padding-bottom:56.25%;">
        <iframe
          src={lesson.source.embedUrl}
          style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;"
          allowfullscreen
        />
      </div>
    </div>
  )}

  <form id="activity-form" class="card">
    <!-- âœ… Campo obligatorio para nombre completo (validado en JS) -->
    <div style="margin-bottom: 1.5rem;">
      <label for="student-fullname">Nombre completo *</label>
      <input 
        type="text" 
        id="student-fullname" 
        required 
        minlength="3"
        placeholder="Ej: Yasser Gandhi HernÃ¡ndez Esquivel"
        style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px;"
      />
      <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.3rem;">
        Este nombre aparecerÃ¡ en tus registros acadÃ©micos
      </p>
    </div>

    <h2>{lesson.activity.title}</h2>
    {lesson.activity.parts.map(part => (
      <div style="margin-bottom:1.5rem;">
        <label for={part.id}>{part.label}</label>
        <p style="font-size:0.8rem; opacity:.7;">{part.help}</p>
        <textarea
          id={part.id}
          rows={part.rows}
          placeholder={part.placeholder}
          required
        />
      </div>
    ))}

    <button type="submit" id="submit-btn" class="btn" style="width:100%;">
      Enviar respuestas
    </button>
  </form>

  <!-- âœ… Contenedor de feedback (inicialmente oculto) -->
  <div
    id="feedback-container"
    class="card"
    style="display:none; margin-top:2rem; border-left:4px solid var(--accent-secondary);"
  >
    <h3 style="margin-top:0;">ğŸ“˜ Feedback del Profesor</h3>
    <div id="feedback-content"></div>
    <!-- âœ… Mensaje de entrega aparece SOLO tras feedback exitoso -->
    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed var(--border-color);">
      <p style="font-weight: bold; color: var(--accent-primary); display: flex; align-items: center; gap: 0.5rem;">
        âœ… <span>Actividad entregada</span>
      </p>
      <p style="font-size: 0.85rem; opacity: 0.8;">
        Tu respuesta ha sido registrada correctamente en el sistema.
      </p>
    </div>
  </div>
</div>

<script>
const form = document.getElementById('activity-form');
const btn = document.getElementById('submit-btn');
const feedbackContainer = document.getElementById('feedback-container');
const feedbackContent = document.getElementById('feedback-content');

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // âœ… ValidaciÃ³n y sanitizaciÃ³n del nombre
  const studentNameInput = document.getElementById('student-fullname');
  const studentName = studentNameInput.value.trim();
  
  if (studentName.length < 3) {
    alert('âš ï¸ Por favor ingresa tu nombre completo (mÃ­nimo 3 caracteres)');
    studentNameInput.focus();
    return;
  }
  
  // ValidaciÃ³n de partes de la actividad
  const part1 = document.getElementById('part1')?.value.trim() || '';
  const part2 = document.getElementById('part2')?.value.trim() || '';
  const part3 = document.getElementById('part3')?.value.trim() || '';
  
  if (!part1 && !part2 && !part3) {
    alert('âš ï¸ Escribe al menos una respuesta antes de enviar.');
    return;
  }
  
  btn.disabled = true;
  btn.innerText = 'Enviando...';
  
  // Construir texto completo con estructura clara
  const text = `
[PARTE 1]
${part1}

[PARTE 2]
${part2}

[PARTE 3]
${part3}
`.trim();
  
  // âœ… Payload con datos validados y sanitizados
  const payload = {
    text,
    studentName, // Nombre limpio y validado
    kurs: 'A1',  // TODO: Obtener dinÃ¡micamente de lesson.kurs
    woche: 1     // TODO: Obtener dinÃ¡micamente de lesson.woche
  };
  
  try {
    const response = await fetch('/api/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    
    if (!response.ok || !result.success) {
      throw new Error(result.error || 'Error desconocido');
    }
    
    // âœ… Mostrar feedback + mensaje de entrega
    feedbackContent.innerHTML = result.feedback;
    feedbackContainer.style.display = 'block';
    
    // Scroll suave al feedback
    feedbackContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    // Reset formulario (opcional)
    // form.reset();
    
  } catch (err) {
    console.error('Error:', err);
    alert(`âŒ Error: ${err.message || 'No se pudo enviar la actividad'}`);
  } finally {
    btn.disabled = false;
    btn.innerText = 'Enviar respuestas';
  }
});
</script>
