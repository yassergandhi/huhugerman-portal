---
import { getBackLink } from '@lib/navigation';

const { lesson } = Astro.props;
const backLink = getBackLink(lesson);

---

<div class="container">
<div class="navbar" style="padding:0; border:none; margin-bottom:1rem;">
  <a
    href={backLink.href}
    style="color:var(--accent-primary); font-weight:bold; display:flex; align-items:center; gap:5px;"
  >
    <span>‚Üê</span> {backLink.label}
  </a>
</div>

  <h1>{lesson.title}</h1>

  <div class="card">
    <h3>üìù Instrucciones de la Actividad</h3>
    <p>{lesson.instructions.intro}</p>

    <ul>
      {lesson.instructions.grammarReminder.map(item => (
        <li>{item}</li>
      ))}
    </ul>
  </div>

  {lesson.source?.type === 'youtube' && (
    <div class="card" style="padding:0;">
      <div style="position:relative; padding-bottom:56.25%;">
        <iframe
          src={lesson.source.embedUrl}
          style="position:absolute; top:0; left:0; width:100%; height:100%; border:0;"
          allowfullscreen
        />
      </div>
    </div>
  )}

  <form id="activity-form" class="card">
    <h2>{lesson.activity.title}</h2>

    {lesson.activity.parts.map(part => (
      <div style="margin-bottom:1.5rem;">
        <label for={part.id}>{part.label}</label>
        <p style="font-size:0.8rem; opacity:.7;">{part.help}</p>
        <textarea
          id={part.id}
          rows={part.rows}
          placeholder={part.placeholder}
        />
      </div>
    ))}

    <button type="submit" id="submit-btn" class="btn" style="width:100%;">
      Enviar respuestas
    </button>
  </form>
</div>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('activity-form');
  const btn = document.getElementById('submit-btn');

  const loadingMessages = [
    "IA Analizando...",
    "Consultando al Tutor...",
    "Corrigiendo gram√°tica...",
    "Preparando tu feedback..."
  ];

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;

    let msgIndex = 0;
    btn.innerText = loadingMessages[0];

    const interval = setInterval(() => {
      msgIndex = (msgIndex + 1) % loadingMessages.length;
      btn.innerText = loadingMessages[msgIndex];
    }, 2500);

    const { data: { user } } = await supabase.auth.getUser();

    const text = `
[PRESENTACI√ìN]
${document.getElementById('part1').value}

[PERSONAJE]
${document.getElementById('part2').value}

[REFLEXI√ìN]
${document.getElementById('part3').value}
`;

    try {
      const response = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      const result = await response.json();
      clearInterval(interval);

      if (!result.success) throw new Error(result.error);

      await supabase.from('submissions').upsert({
        user_id: user.id,
        user_email: user.email,
        session_id: lesson.id,
        content_text: text,
        ai_feedback: result.feedback
      });

      window.location.href = `/dashboard?new_feedback=${encodeURIComponent(result.feedback)}`;

    } catch (err) {
      clearInterval(interval);
      alert("Error: " + err.message);
      btn.disabled = false;
      btn.innerText = "Reintentar";
    }
  });
</script>
