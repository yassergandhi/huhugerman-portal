---
const { session } = Astro.props;
---

<form id="activity-form" class="card">
  <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem;">
    {session.activity.title}
  </h2>

  {session.activity.parts.map((part) => (
    <div style="margin-bottom: 1.5rem;">
      <label>{part.label}</label>
      <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
        {part.help}
      </p>
      <textarea
        id={part.id}
        rows={part.rows}
        placeholder={part.placeholder}
        required
      ></textarea>
    </div>
  ))}

  <button type="submit" id="submit-btn" class="btn" style="width:100%;">
    Enviar y ver Feedback
  </button>

  <p id="status-msg" style="text-align:center; margin-top:1rem;"></p>
</form>

<script>
  const form = document.getElementById('activity-form');
  const btn = document.getElementById('submit-btn');
  const status = document.getElementById('status-msg');

  const loadingMessages = [
    "IA analizando...",
    "Consultando al tutor...",
    "Corrigiendo gramática...",
    "Preparando feedback..."
  ];

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    btn.disabled = true;

    let msgIndex = 0;
    btn.innerHTML = loadingMessages[0];

    const interval = setInterval(() => {
      msgIndex = (msgIndex + 1) % loadingMessages.length;
      btn.innerHTML = loadingMessages[msgIndex];
    }, 2500);

    const parts = [...form.querySelectorAll('textarea')];
    const contentText = parts
      .map(p => `[${p.id.toUpperCase()}]\n${p.value}`)
      .join('\n\n');

    const formData = new FormData();
    formData.append('session_id', session.id);
    formData.append('content_text', contentText);

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        body: formData
      });

      const result = await res.json();
      clearInterval(interval);

      if (!res.ok) throw new Error(result.error || 'Submit failed');

      window.location.href = `/feedback/${result.submission_id}`;
    } catch (err) {
      clearInterval(interval);
      status.innerText = "⚠️ Error al enviar. Intenta de nuevo.";
      btn.disabled = false;
      btn.innerText = "Reintentar";
    }
  });
</script>
