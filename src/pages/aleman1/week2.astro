---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="W-Fragen und Zahlen bis 12">
  <div class="container">
    <div class="navbar" style="padding: 0; border: none; margin-bottom: 1rem;">
      <a href="/dashboard" style="color:var(--accent-primary); font-weight:bold; display: flex; align-items: center; gap: 5px;">
        <span>‚Üê</span> Volver al Dashboard
      </a>
    </div>

    <h1>Woche 2: W-Fragen und Zahlen bis 12</h1>

    <div class="card" style="border-left: 4px solid var(--accent-primary); background: rgba(46, 249, 158, 0.05);">
      <h3 style="margin-top:0; font-size: 1.1rem;">üìù Instrucciones de la Actividad</h3>
      <p style="font-size: 0.95rem; color: var(--text-primary); margin-bottom: 1rem;">
        Esta actividad est√° dise√±ada para que practiques de forma activa las <b>W-Fragen</b> y la informaci√≥n personal b√°sica, tal como se trabaja en nivel A1.
      </p>
      <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; font-size: 0.85rem;">
        <b style="color: var(--accent-secondary);">üí° Objetivo ling√º√≠stico:</b>
        <ul style="margin: 0.5rem 0 0 1.2rem; padding: 0; color: var(--text-secondary);">
          <li>Formular y responder <b>W-Fragen</b>: <i>Was, Wie, Wer, Wo, Woher</i></li>
          <li>Preguntar y decir: <i>Wie ist dein Vorname? Wie ist dein Familienname? Wie ist deine Telefonnummer?</i></li>
          <li>Usar correctamente los verbos: <b>hei√üen, wohnen, kommen, sein</b></li>
          <li>Incorporar n√∫meros del <b>0 al 12</b> (por ejemplo en la edad o el tel√©fono)</li>
        </ul>
      </div>
    </div>
    
<!-- VIDEO √öNICO (CORREGIDO) -->
    <div class="card" style="margin-bottom: 2rem; text-align:center;">
 <iframe width="560" height="315" src="https://www.youtube.com/embed/Yaelm87PTvg?si=rD9-YCZ6XxWPx-qn" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe> 
    </div>

    <form id="activity-form" class="card">
      <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Deine Aufgabe</h2>

      <div style="margin-bottom: 1.5rem;">
        <label>1. Tu presentaci√≥n personal:</label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          Responde a las siguientes preguntas: <i>Wie hei√üt du? Wo wohnst du? Woher kommst du?, Wie ist dein Vorname, Familienname? Wie ist deine Telefonnumer?</i> 
        </p>
        <textarea id="part1" rows="3" placeholder="Ej: Hallo! Ich hei√üe... Ich komme aus... Ich wohne in... Meine Telefonnummer ist... Tsch√ºss!"></textarea>
      </div>
      
      <div style="margin-bottom: 1.5rem;">
        <label>2. Presenta a alguna persona del video: </label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          Incluye respuestas a: <i>Wer ist das? Wie hei√üt er/sie? Wo wohnt er/sie? Woher kommt er/sie?</i>
        </p>
        <textarea id="part2" rows="3" placeholder="Das ist... Er/Sie hei√üt... Er/Sie kommt aus... Er/Sie wohnt in..."></textarea>
      </div>
      
      <div style="margin-bottom: 1.5rem;">
        <label>3. Reflexi√≥n del video:</label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          ¬øQu√© experiencia te dej√≥ el video? ¬øQu√© parte de la fon√©tica se te hizo f√°cil?
        </p>
        <textarea id="part3" rows="4" placeholder="Ej: Wie hei√üt du? ‚Äì Ich hei√üe..."></textarea>
      </div>

      <button type="submit" id="submit-btn" class="btn" style="width:100%;">
        Enviar y ver Feedback
      </button>
      <p id="status-msg" style="text-align:center; margin-top:1rem;"></p>
    </form>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    const form = document.getElementById('activity-form');
    const btn = document.getElementById('submit-btn');

    const loadingMessages = [
      "IA Analizando...",
      "Consultando al Tutor...",
      "Corrigiendo gram√°tica...",
      "Preparando tu feedback..."
    ];

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      
      let msgIndex = 0;
      btn.innerHTML = `<span class="spinner"></span> ${loadingMessages[0]}`;
      
      const interval = setInterval(() => {
        msgIndex = (msgIndex + 1) % loadingMessages.length;
        btn.innerHTML = `<span class="spinner"></span> ${loadingMessages[msgIndex]}`;
      }, 3500);

      const { data: { user } } = await supabase.auth.getUser();
      const text = `[PRESENTACI√ìN]\n${document.getElementById('part1').value}\n\n[PERSONAJE]\n${document.getElementById('part2').value}\n\n[REFLEXI√ìN]\n${document.getElementById('part3').value}`;

      try {
        const response = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const result = await response.json();
        clearInterval(interval);

        if (!result.success) throw new Error(result.error);

        const { error: dbError } = await supabase.from('submissions').upsert({
          user_id: user.id,
          user_email: user.email,
          session_id: 'a1-w2',
          content_text: text,
          ai_feedback: result.feedback
        }, { onConflict: 'user_id,session_id' });

        if (dbError) throw dbError;

        window.location.href = `/dashboard?new_feedback=${encodeURIComponent(result.feedback)}`;

      } catch (err) {
        clearInterval(interval);
        alert("‚ö†Ô∏è Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Reintentar";
      }
    });
  </script>
</Layout>
