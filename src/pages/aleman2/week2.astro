---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Woche 2: Tagesablauf und Uhrzeit">
  <div class="container">
    <div class="navbar" style="padding: 0; border: none; margin-bottom: 1rem;">
      <a href="/dashboard" style="color:var(--accent-primary); font-weight:bold; display: flex; align-items: center; gap: 5px;">
        <span>‚Üê</span> Volver al Dashboard
      </a>
    </div>

    <h1>Woche 2: Tagesablauf, Uhrzeit und Wochentage</h1>

    <div class="card" style="border-left: 4px solid var(--accent-primary); background: rgba(46, 249, 158, 0.05);">
      <h3 style="margin-top:0; font-size: 1.1rem;">üìù Instrucciones de la Actividad</h3>

      <p style="font-size: 0.95rem; color: var(--text-primary); margin-bottom: 1rem;">
        En este video escuchar√°s <b>alem√°n real</b> en entrevistas de la calle.<br>
        El tema central es el <b>Tagesablauf</b> (rutina diaria) en Alemania.
      </p>

      <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <b>Importante:</b><br>
        No necesitas entender todo.<br>
        Conc√©ntrate en <b>las horas</b>, <b>los d√≠as</b> y <b>las acciones</b>.
      </p>

      <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
        üéØ <b>Objetivos ling√º√≠sticos:</b><br>
        ‚Äì Horas formales e informales<br>
        ‚Äì Uso correcto de <b>um</b> (horas) y <b>am</b> (d√≠as)<br>
        ‚Äì Verbos separables: <b>aufstehen</b>, <b>vorlesen</b><br>
        ‚Äì Verbos regulares e irregulares en presente
      </p>

      <div style="background: rgba(0,0,0,0.25); padding: 1rem; border-radius: 8px; font-size: 0.85rem; margin-top:1rem;">
        <b style="color: var(--accent-secondary);">üí° Recordatorio r√°pido</b>
        <ul style="margin: 0.5rem 0 0 1.2rem; padding: 0; color: var(--text-secondary);">
          <li><b>um</b> 7 Uhr / um halb acht</li>
          <li><b>am</b> Montag, am Freitag</li>
          <li>Ich <b>stehe</b> um 7 Uhr <b>auf</b>.</li>
          <li>Ich <b>lese</b> meinem Kind <b>vor</b>.</li>
        </ul>
      </div>
    </div>

    <!-- VIDEO √öNICO (CORREGIDO) -->
    <div class="card" style="margin-bottom: 2rem; text-align:center;">
      <iframe
        width="560"
        height="315"
        src="https://www.youtube.com/embed/R4tlAm2XPiw?si=d2YZpneXKxeLyYL8"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin"
        allowfullscreen>
      </iframe>
    </div>

    <form id="activity-form" class="card">
      <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Deine Aufgaben</h2>

      <div style="margin-bottom: 1.5rem;">
        <label>1. Tagesablauf einer Person aus dem Video</label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          4‚Äì5 S√§tze mit <b>um + Uhrzeit</b>.
        </p>
        <textarea
          id="part1"
          rows="4"
          placeholder="Die Person steht um 6 Uhr auf. Um halb acht beginnt die Arbeit."
        ></textarea>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label>2. Dein typischer Tag</label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          Nutze <b>am + Tag</b> und mindestens <b>ein trennbares Verb</b>.
        </p>
        <textarea
          id="part2"
          rows="4"
          placeholder="Am Montag stehe ich um sieben Uhr auf. Am Abend lese ich etwas vor."
        ></textarea>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label>3. Reflexi√≥n breve</label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          Alem√°n o espa√±ol. Contenido libre.
        </p>
        <textarea
          id="part3"
          rows="4"
          placeholder="Ich finde interessant, dass... / Me llam√≥ la atenci√≥n..."
        ></textarea>
      </div>

      <button type="submit" id="submit-btn" class="btn" style="width:100%;">
        Absenden & Feedback erhalten
      </button>
      <p id="status-msg" style="text-align:center; margin-top:1rem;"></p>
    </form>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    const form = document.getElementById('activity-form');
    const btn = document.getElementById('submit-btn');

    const loadingMessages = [
      "Analysiere Uhrzeiten...",
      "Pr√ºfe trennbare Verben...",
      "Korrigiere S√§tze...",
      "Erstelle Feedback..."
    ];

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;

      let msgIndex = 0;
      btn.innerHTML = `<span class="spinner"></span> ${loadingMessages[0]}`;

      const interval = setInterval(() => {
        msgIndex = (msgIndex + 1) % loadingMessages.length;
        btn.innerHTML = `<span class="spinner"></span> ${loadingMessages[msgIndex]}`;
      }, 3500);

      const { data: { user } } = await supabase.auth.getUser();

      const text = `[THEMA: Tagesablauf, Uhrzeit, Wochentage]

[VIDEO]
${document.getElementById('part1').value}

[MEIN TAG]
${document.getElementById('part2').value}

[REFLEXION]
${document.getElementById('part3').value}`;

      try {
        const response = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const result = await response.json();
        clearInterval(interval);

        if (!result.success) throw new Error(result.error);

        const { error: dbError } = await supabase.from('submissions').upsert({
          user_id: user.id,
          user_email: user.email,
          session_id: 'a2-w1-time',
          content_text: text,
          ai_feedback: result.feedback
        }, { onConflict: 'user_id,session_id' });

        if (dbError) throw dbError;

        window.location.href = `/dashboard?new_feedback=${encodeURIComponent(result.feedback)}`;

      } catch (err) {
        clearInterval(interval);
        alert("‚ö†Ô∏è Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Reintentar";
      }
    });
  </script>
</Layout>
