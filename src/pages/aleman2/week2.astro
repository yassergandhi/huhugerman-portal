---
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';

/* --- 1. LÓGICA DEL SERVIDOR --- */
const { cookies } = Astro;
const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

// Si no hay cookies, inicializamos vacíos para que el cliente maneje el login
let initialData = { part1: "", part2: "", part3: "" };
let user = null;

if (accessToken && refreshToken) {
  const { data } = await supabase.auth.setSession({
    access_token: accessToken.value,
    refresh_token: refreshToken.value,
  });
  user = data.session?.user;

  if (user) {
    const { data: sub } = await supabase
      .from('submissions')
      .select('content_text')
      .eq('session_id', 'week2')
      .eq('user_id', user.id)
      .maybeSingle();

    if (sub?.content_text) {
      const parts = sub.content_text.split(/\[.*?\]/);
      initialData.part1 = parts[1]?.trim() || "";
      initialData.part2 = parts[2]?.trim() || "";
      initialData.part3 = parts[3]?.trim() || "";
    }
  }
}
---

<Layout title="Woche 2: Tagesablauf">
  <div class="container">
    <div class="navbar"><a href="/dashboard">← Dashboard</a></div>
    <h1>Woche 2: Tagesablauf</h1>
    
    <div id="auth-guard">
       <form id="activity-form" class="card" style="display: none;">
          <textarea id="part1">{initialData.part1}</textarea>
          <textarea id="part2">{initialData.part2}</textarea>
          <textarea id="part3">{initialData.part3}</textarea>
          <button type="submit" id="submit-btn" class="btn">Absenden</button>
       </form>
       <div id="login-msg" class="card">Verificando sesión...</div>
    </div>
  </div>
</Layout>

<script type="module">
  import { supabase } from '../../lib/supabase';
  
  // VALIDACIÓN EN CLIENTE (Rompe el bucle de Vercel)
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    window.location.href = "/"; // Redirigir solo si el JS confirma que no hay sesión
  } else {
    document.getElementById('activity-form').style.display = 'block';
    document.getElementById('login-msg').style.display = 'none';
  }

  const form = document.getElementById('activity-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    
    const text = `[VIDEO]\n${document.getElementById('part1').value}\n\n[TAG]\n${document.getElementById('part2').value}\n\n[REF]\n${document.getElementById('part3').value}`;
    
    const res = await fetch('/api/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text })
    });
    const result = await res.json();

    await supabase.from('submissions').upsert({
      user_id: session.user.id,
      user_email: session.user.email,
      session_id: 'week2',
      content_text: text,
      ai_feedback: result.feedback
    }, { onConflict: 'user_id,session_id' });

    window.location.href = `/dashboard?new_feedback=${encodeURIComponent(result.feedback)}`;
  });
</script>
