---
import Layout from '../../layouts/Layout.astro';
---
<Layout title="Woche 1: Konrads Geschichte">
  <div class="container">
    <div class="navbar" style="padding: 0; border: none; margin-bottom: 1rem;">
      <a href="/dashboard" style="color:var(--accent-primary); font-weight:bold; display: flex; align-items: center; gap: 5px;">
        <span>‚Üê</span> Volver al Dashboard
      </a>
    </div>

    <h1>Woche 1: Ein neuer Anfang</h1>

    <div class="card" style="border-left: 4px solid var(--accent-primary); background: rgba(46, 249, 158, 0.05);">
      <h3 style="margin-top:0; font-size: 1.1rem;">üìù Instrucciones de la Actividad</h3>

      <p style="font-size: 0.95rem; color: var(--text-primary); margin-bottom: 1rem;">
        Willkommen in <b>Deutsch 2</b>.<br>
        En este video escuchar√°s <b>alem√°n real</b>, hablado por una persona real.
      </p>

      <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
        <b>Importante:</b><br>
        No necesitas entender todo.<br>
        Conc√©ntrate en las <b>ideas principales</b> y en los <b>datos que reconozcas</b>.
      </p>

      <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
        üéØ <b>Objetivo:</b><br>
        ‚Äì Comprender qui√©n es Konrad<br>
        ‚Äì Escribir oraciones simples con <b>Subjekt (Wer?)</b> y <b>Objekt (Wen/Was?)</b>
      </p>

      <p style="font-size: 0.9rem; color: var(--text-secondary);">
        üëâ Escribe <b>frases cortas</b>. Una idea por frase.<br>
        üëâ <b>No uses diccionario.</b> Conf√≠a en lo que ya sabes.
      </p>

      <div style="background: rgba(0,0,0,0.25); padding: 1rem; border-radius: 8px; font-size: 0.85rem; margin-top:1rem;">
        <b style="color: var(--accent-secondary);">üí° Recordatorio Gramatical (Nominativ)</b>
        <p style="margin: 0.5rem 0; color: var(--text-secondary);">
          <b>Nominativ</b> responde a la pregunta:<br>
          <b>Wer?</b> (¬øQui√©n?)
        </p>
        <p style="margin: 0.5rem 0; color: var(--text-secondary);">
          Se usa para hablar de <b>sobre o presentar a la persona, cosa o acci√≥n. Tip: siempre est√° el verbo sein, werden, nennen o heissen</b>.
        </p>
        <ul style="margin: 0.5rem 0 0 1.2rem; padding: 0; color: var(--text-secondary);">
          <li><b>Er</b> ist sehr motiviert.</li>
        </ul>
      </div>

      <div style="background: rgba(0,0,0,0.25); padding: 1rem; border-radius: 8px; font-size: 0.85rem; margin-top:1rem;">
        <b style="color: var(--accent-secondary);">üí° Recordatorio Gramatical (Akkusativ)</b>
        <p style="margin: 0.5rem 0; color: var(--text-secondary);">
          <b>Akkusativ</b> responde a la pregunta:<br>
          <b>Wen oder was?</b> (¬øA qui√©n? ¬øQu√©?)
        </p>
        <p style="margin: 0.5rem 0; color: var(--text-secondary);">
          Se usa para referirnos <b>a qui√©n o a qu√© le recae la acci√≥n que hace el sujeto.</b>.
        </p>
        <ul style="margin: 0.5rem 0 0 1.2rem; padding: 0; color: var(--text-secondary);">
          <li>Er trainiert <b>die Mannschaft</b>.</li>
        </ul>
        <p style="margin-top:0.5rem; color: var(--text-secondary);">
          ‚ö†Ô∏è Solo en masculino cambia el art√≠culo:<br>
          <b>der ‚Üí den / einen</b><br>
          <i>die</i> y <i>das</i> no cambian.
        </p>
      </div>
    </div>

    <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 2rem;">
      <div style="position: relative; padding-bottom: 56.25%; height: 0;">
        <iframe 
          src="https://www.youtube.com/embed/B1oyDgM_uFY?si=ifvjWVftVhA4dHSm" 
          title="Konrads Geschichte"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;"
          allowfullscreen>
        </iframe>
      </div>
    </div>

    <form id="activity-form" class="card">
      <h2 style="font-size: 1.2rem; margin-bottom: 1.5rem;">Deine Aufgaben</h2>

      <div style="margin-bottom: 1.5rem;">
        <label>1. Wer ist Konrad? (Nominativ)</label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          Schreibe 3‚Äì4 kurze S√§tze.<br>
          Fokus: Namen, Beruf, Alter, Nationalit√§t, usw.
        </p>
        <textarea 
          id="part1" 
          rows="3" 
          placeholder="Das ist Konrad. Er ist Trainer. Er ist sehr motiviert."
        ></textarea>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label>2. Was macht er heute? (Akkusativ)</label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          Schreibe 3 kurze S√§tze.<br>
          Fokus: Was macht o nicht (gern)?
        </p>
        <textarea 
          id="part2" 
          rows="3" 
          placeholder="Er trainiert die Mannschaft. Er benutzt einen Rollstuhl."
        ></textarea>
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label>3. Reflexi√≥n personal</label>
        <p style="font-size: 0.8rem; opacity: 0.7; margin-top: -5px;">
          ¬øCu√°l fue tu experiencia con el video a nivel auditivo, personal e intercultural?<br>
          Puedes escribir en <b>alem√°n o espa√±ol</b>. Aqu√≠ no se eval√∫a la gram√°tica.
        </p>
        <textarea 
          id="part3" 
          rows="4" 
          placeholder="Ich finde seine Geschichte inspirierend... / Pienso que..."
        ></textarea>
      </div>

      <button type="submit" id="submit-btn" class="btn" style="width:100%;">
        Absenden & Feedback erhalten
      </button>
      <p id="status-msg" style="text-align:center; margin-top:1rem;"></p>
    </form>
  </div>

  <script>
    import { supabase } from '../../lib/supabase';

    const form = document.getElementById('activity-form');
    const btn = document.getElementById('submit-btn');

    // Mensajes de carga din√°micos (A2 Feeling)
    const loadingMessages = [
      "Analysiere Nominativ...",
      "Analysiere Akkusativ...",
      "Korrigiere Grammatik...",
      "Erstelle Feedback..."
    ];

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Estado de carga UI
      btn.disabled = true;
      let msgIndex = 0;
      btn.innerHTML = `<span class="spinner"></span> ${loadingMessages[0]}`;
      
      const interval = setInterval(() => {
        msgIndex = (msgIndex + 1) % loadingMessages.length;
        btn.innerHTML = `<span class="spinner"></span> ${loadingMessages[msgIndex]}`;
      }, 3500);

      const { data: { user } } = await supabase.auth.getUser();

      // Construcci√≥n del Prompt para la IA
      const text = `[KONTEXT: Deutsch A2. Thema: Konrad (Rollstuhlfahrer/Trainer). Grammatik: Nominativ vs Akkusativ.]

[TEIL 1: WER IST KONRAD? (NOMINATIV)]
${document.getElementById('part1').value}

[TEIL 2: WAS MACHT ER? (AKKUSATIV)]
${document.getElementById('part2').value}

[TEIL 3: REFLEXION]
${document.getElementById('part3').value}`;

      try {
        // 1. Obtener Feedback de la API
        const response = await fetch('/api/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const result = await response.json();
        clearInterval(interval);

        if (!result.success) throw new Error(result.error);

        // 2. Guardar en Supabase (UPSERT)
        // NOTA: session_id es 'a2-w1' para que no se mezcle con A1
        const { error: dbError } = await supabase.from('submissions').upsert({
          user_id: user.id,
          user_email: user.email,
          session_id: 'a2-w1',
          content_text: text,
          ai_feedback: result.feedback
        }, { onConflict: 'user_id,session_id' });

        if (dbError) throw dbError;

        // 3. Redirigir al Dashboard con el feedback
        window.location.href = `/dashboard?new_feedback=${encodeURIComponent(result.feedback)}`;

      } catch (err) {
        clearInterval(interval);
        console.error(err);
        alert("‚ö†Ô∏è Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Reintentar";
      }
    });
  </script>
</Layout>
